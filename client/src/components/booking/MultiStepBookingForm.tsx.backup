import { useState, useRef, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useMutation } from "@tanstack/react-query";
import { bookingFormSchema } from "@shared/schema";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { useIsMobile } from "@/hooks/use-mobile";
import { z } from "zod";
import { CheckCircle, ArrowRight, ArrowLeft, MapPin, Calendar, Car, Settings, 
  ClipboardList, Clock, DollarSign, X, Check, Droplets, Sparkles, 
  Search, PenTool, Brush, ShieldCheck, Truck, Layers, ChevronsUp } from "lucide-react";
import LocationSearch from "./LocationSearch";
import { ThreeDButton } from "@/components/ui/3d-button";
import { ThreeDStepIcon, BackButton } from "@/components/ui/3d-step-icon";

import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Card,
  CardContent,
} from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Checkbox } from "@/components/ui/checkbox";

type FormValues = z.infer<typeof bookingFormSchema>;

// Vehicle Types with pricing tiers
const vehicleTypes = [
  { value: "sedan", label: "Sedan", icon: <Car className="w-6 h-6 text-primary-red" />, description: "Standard 4-door car", priceTier: "low" },
  { value: "coupe", label: "Coupe", icon: <Car className="w-6 h-6 text-primary-red" />, description: "2-door sporty car", priceTier: "low" },
  { value: "suv", label: "SUV/Crossover", icon: <Truck className="w-6 h-6 text-primary-red" />, description: "Sport utility vehicle", priceTier: "mid" },
  { value: "truck", label: "Truck", icon: <Truck className="w-6 h-6 text-primary-red" />, description: "Pickup truck", priceTier: "mid" },
  { value: "van", label: "Van/Minivan", icon: <Truck className="w-6 h-6 text-primary-red" />, description: "Family or cargo van", priceTier: "high" },
  { value: "luxury", label: "Luxury/Sports Car", icon: <Car className="w-6 h-6 text-primary-red" />, description: "High-end performance vehicle", priceTier: "high" },
];

// Categories 
const serviceCategories = [
  { value: "interior", label: "Interior Only", icon: <Brush className="w-6 h-6 text-primary-red" />, description: "Focus on cleaning the inside of your vehicle" },
  { value: "exterior", label: "Exterior Only", icon: <Droplets className="w-6 h-6 text-primary-red" />, description: "Focus on making the outside shine" },
  { value: "complete", label: "Complete Package", icon: <Sparkles className="w-6 h-6 text-primary-red" />, description: "Full interior and exterior detailing" }
];

// Service prices for each vehicle tier based on image (static pricing)
const servicePrices = {
  // Sedan/Coupe Tier (Tier 1 - lowest prices)
  sedan: {
    interior: {
      "interior-deep-clean": { price: 150, duration: "2-4 hours" }
    },
    exterior: {
      "express-detail": { price: 125, duration: "2 hours" },
      "exterior-wash-wax": { price: 200, duration: "2-4 hours" },
      "exterior-polish-wax": { price: 350, duration: "3-6 hours" }
    },
    complete: {
      "luxury-full-detail": { price: 550, duration: "4-8 hours" },
      "showroom-prep": { price: 699, duration: "7-8 hours" }
    }
  },
  
  // SUV/Truck Tier (Tier 2 - middle range prices)
  suv: {
    interior: {
      "interior-deep-clean": { price: 250, duration: "2-4 hours" }
    },
    exterior: {
      "express-detail": { price: 150, duration: "2 hours" },
      "exterior-wash-wax": { price: 300, duration: "2-4 hours" },
      "exterior-polish-wax": { price: 400, duration: "3-6 hours" }
    },
    complete: {
      "luxury-full-detail": { price: 699, duration: "4-8 hours" },
      "showroom-prep": { price: 849, duration: "7-8 hours" }
    }
  },
  
  // Van/Luxury Tier (Tier 3 - highest prices)
  luxury: {
    interior: {
      "interior-deep-clean": { price: 350, duration: "2-4 hours" }
    },
    exterior: {
      "express-detail": { price: 175, duration: "2 hours" },
      "exterior-wash-wax": { price: 400, duration: "2-4 hours" },
      "exterior-polish-wax": { price: 450, duration: "3-6 hours" }
    },
    complete: {
      "luxury-full-detail": { price: 850, duration: "4-8 hours" },
      "showroom-prep": { price: 999, duration: "7-8 hours" }
    }
  }
};

// Service Packages (displayed options)
const servicePackages = {
  interior: [
    { 
      value: "interior-deep-clean", 
      label: "Interior Detail Deep Clean", 
      basePrice: servicePrices.sedan.interior["interior-deep-clean"].price,
      duration: servicePrices.sedan.interior["interior-deep-clean"].duration, 
      description: "Thorough cleaning of all interior surfaces, carpet & upholstery cleaning, stain removal, leather conditioning, and protection" 
    }
  ],
  exterior: [
    { 
      value: "express-detail", 
      label: "Express Detail", 
      basePrice: servicePrices.sedan.exterior["express-detail"].price,
      duration: servicePrices.sedan.exterior["express-detail"].duration, 
      description: "Quick exterior wash, tire shine, and basic wax protection" 
    },
    { 
      value: "exterior-wash-wax", 
      label: "Exterior Wash & Wax", 
      basePrice: servicePrices.sedan.exterior["exterior-wash-wax"].price,
      duration: servicePrices.sedan.exterior["exterior-wash-wax"].duration, 
      description: "Thorough wash, premium wax application, wheel cleaning, and tire shine" 
    },
    { 
      value: "exterior-polish-wax", 
      label: "Exterior Polish & Wax", 
      basePrice: servicePrices.sedan.exterior["exterior-polish-wax"].price,
      duration: servicePrices.sedan.exterior["exterior-polish-wax"].duration, 
      description: "Full exterior polish to remove minor scratches and swirls, followed by premium wax protection" 
    }
  ],
  complete: [
    { 
      value: "luxury-full-detail", 
      label: "Luxury Full Detail", 
      basePrice: servicePrices.sedan.complete["luxury-full-detail"].price,
      duration: servicePrices.sedan.complete["luxury-full-detail"].duration, 
      description: "Complete interior and exterior detailing with premium products and extra attention to detail" 
    },
    { 
      value: "showroom-prep", 
      label: "Showroom Prep", 
      basePrice: servicePrices.sedan.complete["showroom-prep"].price,
      duration: servicePrices.sedan.complete["showroom-prep"].duration, 
      description: "Our most comprehensive package bringing your vehicle to like-new condition with ceramic coating" 
    }
  ]
};

// Add-on Services
const addOnServices = [
  { id: "carpet", label: "Carpet Conditioning", price: "+$100", description: "Deep conditioning treatment for carpets and floor mats" },
  { id: "leather", label: "Leather Conditioning", price: "+$50", description: "Deep conditioning and UV protection for leather surfaces" },
  { id: "clay", label: "Clay Bar", price: "+$50", description: "Removes embedded contaminants from paint" },
  { id: "spray-wax", label: "Spray Wax", price: "+$65", description: "Additional layer of wax protection for your vehicle" },
  { id: "headlights", label: "Headlight Restoration", price: "+$50-$100", description: "Restore yellowed or cloudy headlights" },
  { id: "headliner", label: "Headliner Restore", price: "+$50-$75", description: "Clean and restore vehicle headliner" },
  { id: "scratch", label: "Scratch Buffing", price: "+$65-$95", description: "Buff out minor scratches from your vehicle's paint" },
  { id: "plastic", label: "Interior Plastic/Chrome Polishing", price: "+$45-$85", description: "Restore and polish interior plastic and chrome surfaces" }
];

// Time Slots
const timeSlots = [
  { value: "08:00", label: "8:00 AM" },
  { value: "09:00", label: "9:00 AM" },
  { value: "10:00", label: "10:00 AM" },
  { value: "11:00", label: "11:00 AM" },
  { value: "12:00", label: "12:00 PM" },
  { value: "13:00", label: "1:00 PM" },
  { value: "14:00", label: "2:00 PM" },
  { value: "15:00", label: "3:00 PM" },
  { value: "16:00", label: "4:00 PM" }
];

// Steps configuration
const steps = [
  { 
    id: "location", 
    title: "Location", 
    description: "Where should we meet you?", 
    icon: <MapPin className="h-5 w-5" /> 
  },
  { 
    id: "vehicle", 
    title: "Vehicle Type", 
    description: "Tell us about your vehicle", 
    icon: <Car className="h-5 w-5" /> 
  },
  { 
    id: "category", 
    title: "Service Category", 
    description: "What type of service do you need?", 
    icon: <Settings className="h-5 w-5" /> 
  },
  { 
    id: "service", 
    title: "Select Package", 
    description: "Choose your detailing package", 
    icon: <ClipboardList className="h-5 w-5" /> 
  },
  { 
    id: "appointment", 
    title: "Date & Time", 
    description: "When would you like us to come?", 
    icon: <Calendar className="h-5 w-5" /> 
  },
  { 
    id: "condition", 
    title: "Vehicle Condition", 
    description: "Tell us about your vehicle's condition", 
    icon: <Car className="h-5 w-5" /> 
  },
  { 
    id: "contact", 
    title: "Your Details", 
    description: "How can we reach you?", 
    icon: <Clock className="h-5 w-5" /> 
  },
  { 
    id: "review", 
    title: "Review", 
    description: "Confirm your booking details", 
    icon: <DollarSign className="h-5 w-5" /> 
  },
  { 
    id: "confirmation", 
    title: "Confirmation", 
    description: "Your booking is complete!", 
    icon: <CheckCircle className="h-5 w-5" /> 
  }
];

export default function MultiStepBookingForm() {
  const { toast } = useToast();
  const [currentStep, setCurrentStep] = useState(0);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [selectedAddOns, setSelectedAddOns] = useState<string[]>([]);
  const [selectedAddOnDetails, setSelectedAddOnDetails] = useState<{id: string, price: string}[]>([]);
  const [bookingReference, setBookingReference] = useState<string>("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isValidAddress, setIsValidAddress] = useState(false);
  const [addressCoordinates, setAddressCoordinates] = useState<[number, number] | undefined>(undefined);
  const stepsRef = useRef<HTMLDivElement>(null);
  
  // Extract price value as numeric
  const extractPrice = (priceString: string): number => {
    // Special handling for price ranges (e.g., "+$45-$85")
    if (priceString.includes('-')) {
      // Take the lower value in the range for conservative pricing
      const rangeMatch = priceString.match(/\$(\d+)-\$(\d+)/);
      if (rangeMatch && rangeMatch[1]) {
        return parseFloat(rangeMatch[1]) || 0;
      }
    }
    
    // Standard case: remove non-numeric characters except for decimal points
    const numericString = priceString.replace(/[^0-9.]/g, '');
    return parseFloat(numericString) || 0;
  };
  
  // Calculate price based on vehicle type
  // Get the price for a service based on the vehicle type
  const getServicePrice = (serviceValue: string, serviceCategory: string, vehicleType: string): number => {
    // Map vehicle type to one of our three pricing tiers
    const priceTier = vehicleType === 'sedan' || vehicleType === 'coupe' ? 'sedan' : 
                     (vehicleType === 'suv' || vehicleType === 'truck') ? 'suv' : 'luxury';
    
    try {
      // Type-safe lookup for sedan/coupe tier
      if (priceTier === 'sedan') {
        if (serviceCategory === 'interior') {
          if (serviceValue === 'interior-deep-clean') {
            return servicePrices.sedan.interior["interior-deep-clean"].price;
          }
        } else if (serviceCategory === 'exterior') {
          if (serviceValue === 'express-detail') {
            return servicePrices.sedan.exterior["express-detail"].price;
          } else if (serviceValue === 'exterior-wash-wax') {
            return servicePrices.sedan.exterior["exterior-wash-wax"].price;
          } else if (serviceValue === 'exterior-polish-wax') {
            return servicePrices.sedan.exterior["exterior-polish-wax"].price;
          }
        } else if (serviceCategory === 'complete') {
          if (serviceValue === 'luxury-full-detail') {
            return servicePrices.sedan.complete["luxury-full-detail"].price;
          } else if (serviceValue === 'showroom-prep') {
            return servicePrices.sedan.complete["showroom-prep"].price;
          }
        }
      } 
      // Type-safe lookup for SUV/truck tier
      else if (priceTier === 'suv') {
        if (serviceCategory === 'interior') {
          if (serviceValue === 'interior-deep-clean') {
            return servicePrices.suv.interior["interior-deep-clean"].price;
          }
        } else if (serviceCategory === 'exterior') {
          if (serviceValue === 'express-detail') {
            return servicePrices.suv.exterior["express-detail"].price;
          } else if (serviceValue === 'exterior-wash-wax') {
            return servicePrices.suv.exterior["exterior-wash-wax"].price;
          } else if (serviceValue === 'exterior-polish-wax') {
            return servicePrices.suv.exterior["exterior-polish-wax"].price;
          }
        } else if (serviceCategory === 'complete') {
          if (serviceValue === 'luxury-full-detail') {
            return servicePrices.suv.complete["luxury-full-detail"].price;
          } else if (serviceValue === 'showroom-prep') {
            return servicePrices.suv.complete["showroom-prep"].price;
          }
        }
      }
      // Type-safe lookup for luxury/van tier
      else if (priceTier === 'luxury') {
        if (serviceCategory === 'interior') {
          if (serviceValue === 'interior-deep-clean') {
            return servicePrices.luxury.interior["interior-deep-clean"].price;
          }
        } else if (serviceCategory === 'exterior') {
          if (serviceValue === 'express-detail') {
            return servicePrices.luxury.exterior["express-detail"].price;
          } else if (serviceValue === 'exterior-wash-wax') {
            return servicePrices.luxury.exterior["exterior-wash-wax"].price;
          } else if (serviceValue === 'exterior-polish-wax') {
            return servicePrices.luxury.exterior["exterior-polish-wax"].price;
          }
        } else if (serviceCategory === 'complete') {
          if (serviceValue === 'luxury-full-detail') {
            return servicePrices.luxury.complete["luxury-full-detail"].price;
          } else if (serviceValue === 'showroom-prep') {
            return servicePrices.luxury.complete["showroom-prep"].price;
          }
        }
      }
      
      console.error('Unable to find price for this service/vehicle combination:', {serviceValue, serviceCategory, vehicleType, priceTier});
      return 0;
    } catch (error) {
      console.error('Error getting service price:', error);
      return 0;
    }
  };

  // Calculate total price including add-ons
  const calculateTotalPrice = (serviceInfo: any, vehicleType: string, addOns: {id: string, price: string}[]): string => {
    // Get the static price based on service and vehicle type
    let basePrice = 0;
    
    if (serviceInfo && vehicleType) {
      // Get price from our fixed price tiers
      basePrice = getServicePrice(serviceInfo.value, form.getValues().serviceCategory, vehicleType);
    }
    
    // Add the add-on costs
    const addOnTotal = addOns.reduce((total, addon) => {
      return total + extractPrice(addon.price);
    }, 0);
    
    // Return price as a whole number (no decimal places)
    return `$${Math.round(basePrice + addOnTotal)}`;
  };
  
  // Calculate reference number
  const generateBookingReference = (): string => {
    const prefix = "BK";
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}-${random}`;
  };
  
  // Track user interactions
  const trackInteraction = (action: string, field: string, value: string) => {
    // Analytics would go here in a real app
    console.log(`User Interaction: ${action} - ${field}:`, value);
  };
  
  // Form initialization
  const form = useForm<FormValues>({
    resolver: zodResolver(bookingFormSchema),
    defaultValues: {
      firstName: "",
      lastName: "",
      email: "",
      phone: "",
      location: "",
      vehicleType: "",
      serviceCategory: "",
      mainService: "",
      addOns: "",
      appointmentDate: "",
      appointmentTime: "",
      conditionNotes: "",
      totalPrice: "$0",
      totalDuration: "",
    },
  });
  
  // Watch for changes to fields we're interested in
  const watchVehicleType = form.watch("vehicleType");
  const watchServiceCategory = form.watch("serviceCategory");
  const watchMainService = form.watch("mainService");
  const watchAddOns = form.watch("addOns");
  
  // Update the selected category when the service category changes
  useEffect(() => {
    if (watchServiceCategory) {
      setSelectedCategory(watchServiceCategory);
      
      // Reset main service when category changes
      form.setValue("mainService", "");
      
      console.log("Selected category changed to:", watchServiceCategory);
    }
  }, [watchServiceCategory, form]);
  
  // Update duration based on selected service
  useEffect(() => {
    if (watchMainService && selectedCategory) {
      const services = servicePackages[selectedCategory as keyof typeof servicePackages];
      const serviceInfo = services.find(s => s.value === watchMainService);
      
      if (serviceInfo) {
        form.setValue("totalDuration", serviceInfo.duration);
        console.log("Duration set to:", serviceInfo.duration);
      }
    }
  }, [watchMainService, selectedCategory, form]);
  
  // Update total price when vehicle type, service, or add-ons change
  useEffect(() => {
    // Only proceed if we have both vehicle type and main service selected
    if (watchVehicleType && watchMainService && selectedCategory) {
      const services = servicePackages[selectedCategory as keyof typeof servicePackages];
      const serviceInfo = services.find(s => s.value === watchMainService);
      
      if (serviceInfo) {
        // Calculate total price with currently selected add-ons
        const totalPrice = calculateTotalPrice(serviceInfo, watchVehicleType, selectedAddOnDetails);
        form.setValue("totalPrice", totalPrice);
        console.log("Total price updated to:", totalPrice);
      }
    }
  }, [watchVehicleType, watchMainService, selectedCategory, selectedAddOnDetails, form]);
  
  // Process add-ons when they're selected
  useEffect(() => {
    if (watchAddOns) {
      try {
        // Parse the add-ons string to an array
        const addOnIds = watchAddOns.split(',').filter(id => id.trim() !== '');
        setSelectedAddOns(addOnIds);
        
        // Map the IDs to full details for each add-on
        const addOnDetails = addOnIds.map(id => {
          const addOn = addOnServices.find(a => a.id === id);
          return {
            id,
            price: addOn ? addOn.price : "+$0"
          };
        });
        
        setSelectedAddOnDetails(addOnDetails);
        console.log("Selected add-ons:", addOnDetails);
      } catch (error) {
        console.error("Error processing add-ons:", error);
      }
    } else {
      // Clear selections when there are no add-ons
      setSelectedAddOns([]);
      setSelectedAddOnDetails([]);
    }
  }, [watchAddOns]);
  
  // Validation for current step
  const validateCurrentStep = () => {
    switch (currentStep) {
      case 0: // Location
        if (!form.getValues().location || !isValidAddress) {
          toast({
            title: "Please enter a valid address",
            description: "We need a valid service location within our service area to proceed.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      case 1: // Vehicle Type
        if (!form.getValues().vehicleType) {
          toast({
            title: "Please select a vehicle type",
            description: "This helps us prepare the right equipment for your service.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      case 2: // Service Category
        if (!form.getValues().serviceCategory) {
          toast({
            title: "Please select a service category",
            description: "Choose interior only, exterior only, or complete package.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      case 3: // Main Service
        if (!form.getValues().mainService) {
          toast({
            title: "Please select a service package",
            description: "Choose one of our detailing packages to proceed.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      case 4: // Date & Time
        if (!form.getValues().appointmentDate || !form.getValues().appointmentTime) {
          toast({
            title: "Please select both date and time",
            description: "We need to know when you'd like us to perform the service.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      case 5: // Vehicle Condition (optional)
        // No validation needed for optional fields
        return true;
        
      case 6: // Contact Details
        const { firstName, lastName, email, phone } = form.getValues();
        if (!firstName || !lastName || !email || !phone) {
          toast({
            title: "Please complete all contact fields",
            description: "We need your name, email, and phone to confirm your booking.",
            variant: "destructive",
          });
          return false;
        }
        // Simple email validation
        if (!/\S+@\S+\.\S+/.test(email)) {
          toast({
            title: "Invalid email address",
            description: "Please enter a valid email address.",
            variant: "destructive",
          });
          return false;
        }
        // Simple phone validation (at least 10 digits)
        if (!/^\d{10,}$/.test(phone.replace(/\D/g, ''))) {
          toast({
            title: "Invalid phone number",
            description: "Please enter a valid phone number with at least 10 digits.",
            variant: "destructive",
          });
          return false;
        }
        return true;
        
      default:
        return true;
    }
  };
  
  // Handle form submission
  const submitBooking = async (data: FormValues) => {
    console.log('Submitting booking data:', data);
    setIsSubmitting(true);
    
    try {
      // Generate reference for UI display before submission
      const reference = generateBookingReference();
      setBookingReference(reference);
      
      // Add the complete address and coordinates if available
      const dataWithExtras = {
        ...data,
        coordinates: addressCoordinates ? addressCoordinates.join(',') : '',
        submittedFrom: window.location.href,
        userAgent: navigator.userAgent,
        bookingReference: reference,
        status: 'new'
      };
      
      // Submit to server
      const response = await apiRequest('/api/bookings', {
        method: 'POST',
        body: JSON.stringify(dataWithExtras),
      });
      
      console.log('Booking submitted successfully:', response);
      
      // Move to confirmation step
      setCurrentStep(steps.length - 1);
      
      toast({
        title: "Booking Submitted!",
        description: `Your booking reference is ${reference}. We'll be in touch shortly to confirm your appointment.`,
        variant: "default",
      });
    } catch (error) {
      console.error('Error submitting booking:', error);
      
      toast({
        title: "Submission Failed",
        description: "We encountered an error while submitting your booking. Please try again or contact us directly.",
        variant: "destructive",
      });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  // Booking request mutation
  const bookingMutation = useMutation({
    mutationFn: (data: FormValues) => {
      return submitBooking(data);
    },
  });
  
  // Handle form submission via react-hook-form
  const onSubmit = (data: FormValues) => {
    console.log("Form data to be submitted:", data);
    bookingMutation.mutate(data);
  };
  
  // Advance to next step
  const handleNext = () => {
    console.log('NAVIGATION: Proceeding from step', currentStep, 'to step', currentStep+1);
    
    if (validateCurrentStep()) {
      if (currentStep < steps.length - 1) {
        // Special handling for review step - show confirmation on submit
        if (currentStep === 6) {
          setCurrentStep(prev => prev + 1);
          
          // Simplified scrolling for review step
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          
          // Additional scroll with element reference for reliability
          setTimeout(() => {
            if (stepsRef.current) {
              stepsRef.current.scrollIntoView({
                behavior: 'smooth', 
                block: 'start'
              });
            }
          }, 50);
        } 
        // Final review to confirmation - submit the form
        else if (currentStep === 7) {
          console.log('Review step complete - submitting form');
          form.handleSubmit(onSubmit)();
        }
        // Regular step advancement
        else {
          setCurrentStep(prev => prev + 1);
          
          // Check if we're now on step 4 (date/time) coming from step 3 (service packages)
          const isServiceToDateTransition = currentStep === 3;
          
          if (isServiceToDateTransition && window.innerWidth < 768) {
            // Improved handling for critical transition on mobile
            console.log('Critical transition: Service packages to date/time - using improved scrolling');
            
            // Two-phase approach similar to handlePrevious
            window.scrollTo(0, 0); // Instant scroll first
            
            // Then smooth scroll with a slight delay
            setTimeout(() => {
              if (stepsRef.current) {
                stepsRef.current.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              }
            }, 50);
          } else {
            // Gentler approach for non-critical transitions
            window.scrollTo({
              top: 0,
              behavior: 'smooth'
            });
            
            // Element reference scrolling with slight delay
            if (stepsRef.current) {
              setTimeout(() => {
                stepsRef.current.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              }, 50);
            }
          }
        }
      }
    }
  };
  
  // Go back to previous step
  const handlePrevious = () => {
    // Simple log for navigation tracking
    console.log('NAVIGATION: Going back from step', currentStep, 'to step', currentStep-1);
    
    if (currentStep > 0) {
      // Check if we're navigating from date/time back to service packages
      const isDateToServiceTransition = currentStep === 4; // Going from date/time back to service packages
      
      setCurrentStep(prev => prev - 1);
      
      // Simplified, smoother scrolling approach that still ensures reliability
      if (isDateToServiceTransition) {
        // For critical transitions, use a two-phase approach:
        // First, instant scroll to ensure we're at the top
        window.scrollTo(0, 0);
        
        // Then smooth scroll to the reference element with a slight delay
        setTimeout(() => {
          if (stepsRef.current) {
            stepsRef.current.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        }, 50);
      } else {
        // For non-critical transitions, use a gentler approach
        if (stepsRef.current) {
          window.scrollTo({
            top: Math.max(0, stepsRef.current.offsetTop - 20),
            behavior: 'smooth'
          });
        } else {
          // Fallback if reference element isn't available
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        }
      }
    }
  };
  
  // Get service price adjusted for vehicle type
  const getAdjustedPrice = (serviceInfo: any, vehicleType: string): string => {
    if (!serviceInfo || !vehicleType) return "$0";
    
    try {
      // Get price from our pricing tiers
      const price = getServicePrice(serviceInfo.value, form.getValues().serviceCategory, vehicleType);
      
      // Format as whole dollar amount (no decimals)
      return `$${price}`;
    } catch (error) {
      console.error('Error in getAdjustedPrice:', error);
      return "$0";
    }
  };
  
  // Find selected service details with adjusted price based on vehicle type
  const getSelectedServiceDetails = () => {
    if (!selectedCategory || !watchMainService) return null;
    
    const services = servicePackages[selectedCategory as keyof typeof servicePackages];
    const serviceInfo = services.find(s => s.value === watchMainService);
    
    if (serviceInfo) {
      const vehicleType = form.getValues().vehicleType;
      // Add the price property adjusted for vehicle type
      return {
        ...serviceInfo,
        price: getAdjustedPrice(serviceInfo, vehicleType)
      };
    }
    
    return null;
  };

  const isMobile = useIsMobile();

  return (
    <div className="bg-[#F3F4E6] py-8 md:py-10">
      <div className="container mx-auto px-3 sm:px-4">
        <div className="mb-8 md:mb-12 text-center">
          <h1 className="text-2xl sm:text-3xl md:text-4xl font-bold mb-3 md:mb-4 text-gray-900">Book Your Mobile Detailing Service</h1>
          <p className="text-gray-600 text-sm md:text-base max-w-2xl mx-auto">Experience premium car detailing at your home or office. Our expert team brings everything needed to transform your vehicle.</p>
        </div>
        
        <div ref={stepsRef} className="relative mb-6 md:mb-10">
          {/* Desktop progress indicator */}
          <div className="hidden md:flex justify-between items-center mb-4">
            {steps.map((step, index) => (
              <div 
                key={step.id}
                className={`relative flex flex-col items-center ${
                  index <= currentStep ? 'text-primary' : 'text-gray-400'
                }`}
                style={{ width: `${100 / steps.length}%` }}
              >
                <ThreeDStepIcon 
                  status={
                    index < currentStep 
                      ? 'completed' 
                      : index === currentStep 
                        ? 'active' 
                        : 'upcoming'
                  }
                >
                  {index < currentStep ? (
                    <Check className="h-5 w-5" />
                  ) : (
                    step.icon
                  )}
                </ThreeDStepIcon>
                <div className="text-xs mt-4 font-medium hidden md:block">{step.title}</div>
              </div>
            ))}
            
            {/* Progress bar */}
            <div 
              className="absolute top-5 h-1 bg-gray-200 left-0 right-0 -z-10"
              style={{ transform: "translateY(-50%)" }}
            ></div>
            <div 
              className="absolute top-5 h-1 bg-primary left-0 -z-10 transition-all duration-300"
              style={{ 
                transform: "translateY(-50%)",
                width: `${(currentStep / (steps.length - 1)) * 100}%` 
              }}
            ></div>
          </div>
          
          {/* Mobile progress indicator - simplified dots */}
          <div className="md:hidden flex items-center justify-center space-x-1 mb-4">
            {steps.map((_, index) => (
              <div 
                key={index}
                className={`h-2 rounded-full transition-all ${
                  index === currentStep ? 'w-6 bg-primary' : 
                  index < currentStep ? 'w-3 bg-primary' : 'w-3 bg-gray-300'
                }`}
              ></div>
            ))}
          </div>
          
          {/* Mobile step indicator */}
          <div className="text-center md:hidden mb-4">
            <div className="flex justify-center mb-2">
              <ThreeDStepIcon status="active">
                {steps[currentStep].icon}
              </ThreeDStepIcon>
            </div>
            <h3 className="text-xl font-bold">{steps[currentStep].title}</h3>
            <p className="text-gray-600 text-sm">{steps[currentStep].description}</p>
          </div>
        </div>
        
        {/* Main form card - adjusted padding for mobile */}
        <Card className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border-gray-200">
          <CardContent className="p-4 sm:p-6 md:p-8">
            <Form {...form}>
              <div className="space-y-6">
                {/* Step 1: Location */}
                {currentStep === 0 && (
                  <div className="space-y-4">
                    <h2 className="text-xl font-bold hidden md:block">Where should we meet you?</h2>
                    <p className="text-gray-600 mb-6 hidden md:block">
                      We'll come to your location with all the equipment needed for a perfect detail.
                    </p>
                    
                    <FormField
                      control={form.control}
                      name="location"
                      render={({ field }) => (
                        <>
                          <LocationSearch 
                            value={field.value} 
                            onChange={field.onChange}
                            onAddressValidated={(isValid, coordinates) => {
                              setIsValidAddress(isValid);
                              if (coordinates) {
                                setAddressCoordinates(coordinates);
                              }
                              
                              if (!isValid && field.value) {
                                toast({
                                  title: "Location Outside Service Area",
                                  description: "We currently only service areas within California, from Sacramento to San Diego. Please enter a location within our service area.",
                                  variant: "destructive",
                                });
                              } else if (isValid && field.value) {
                                toast({
                                  title: "Address Verified",
                                  description: "Great! Your location is within our service area.",
                                  variant: "default",
                                });
                              }
                            }}
                            field={field}
                            formState={form.formState}
                          />
                          
                          {field.value && !isValidAddress && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                              <div className="flex items-start">
                                <X className="h-5 w-5 text-red-500 mr-2 mt-0.5" />
                                <div>
                                  <h4 className="text-sm font-medium text-red-800">Outside Service Area</h4>
                                  <p className="text-sm text-red-700 mt-1">
                                    The address you've entered is outside our service area. We currently only service locations within California, from Sacramento to San Diego. Please enter a different address or contact us for special arrangements.
                                  </p>
                                </div>
                              </div>
                            </div>
                          )}
                        </>
                      )}
                    />
                  </div>
                )}
                
                {/* Step 2: Vehicle Type */}
                {currentStep === 1 && (
                  <div className="space-y-4">
                    <h2 className="text-xl font-bold hidden md:block">Select Your Vehicle Type</h2>
                    <p className="text-gray-600 mb-6 hidden md:block">
                      This helps us prepare the right equipment and supplies for your vehicle.
                    </p>
                    
                    <FormField
                      control={form.control}
                      name="vehicleType"
                      render={({ field }) => (
                        <FormItem className="space-y-3">
                          <FormLabel>Vehicle Type</FormLabel>
                          <FormControl>
                            <RadioGroup
                              onValueChange={(value) => {
                                // Track vehicle type selection
                                trackInteraction('select_vehicle_type', 'vehicleType', value);
                                field.onChange(value);
                              }}
                              defaultValue={field.value}
                              className="grid grid-cols-1 sm:grid-cols-2 gap-3"
                            >
                              {vehicleTypes.map((vehicle) => (
                                <div 
                                  key={vehicle.value} 
                                  className={`relative bg-white rounded-lg cursor-pointer transition-all shadow-sm 
                                    ${field.value === vehicle.value 
                                      ? 'border-2 border-primary transform -translate-y-1' 
                                      : 'border border-gray-200 hover:border-gray-300 hover:-translate-y-1'
                                    }
                                    before:absolute before:rounded-lg before:inset-0 before:bottom-[-5px] 
                                    before:bg-gray-100 before:-z-10 before:border before:border-gray-200
                                  `}
                                  onClick={() => field.onChange(vehicle.value)}
                                >
                                  <div className="p-4">
                                    <RadioGroupItem
                                      value={vehicle.value}
                                      id={vehicle.value}
                                      className="sr-only"
                                    />
                                    <div className="flex items-center">
                                      <div className={`mr-3 text-2xl p-2 rounded-full ${field.value === vehicle.value ? 'bg-primary/10' : 'bg-gray-100'}`}>
                                        {vehicle.icon}
                                      </div>
                                      <div>
                                        <label 
                                          htmlFor={vehicle.value}
                                          className="block font-medium cursor-pointer"
                                        >
                                          {vehicle.label}
                                        </label>
                                        <span className="text-sm text-gray-500">{vehicle.description}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </RadioGroup>
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                )}
                
                {/* Step 3: Service Category */}
                {currentStep === 2 && (
                  <div className="space-y-4">
                    <h2 className="text-xl font-bold hidden md:block">Select Service Category</h2>
                    <p className="text-gray-600 mb-6 hidden md:block">
                      What type of detailing service are you looking for?
                    </p>
                    
                    <FormField
                      control={form.control}
                      name="serviceCategory"
                      render={({ field }) => (
                        <FormItem className="space-y-3">
                          <FormLabel>Service Category</FormLabel>
                          <FormControl>
                            <RadioGroup
                              onValueChange={field.onChange}
                              defaultValue={field.value}
                              className="flex flex-col space-y-3"
                            >
                              {serviceCategories.map((category) => (
                                <div 
                                  key={category.value} 
                                  className={`relative bg-white rounded-lg cursor-pointer transition-all shadow-sm 
                                    ${field.value === category.value 
                                      ? 'border-2 border-primary transform -translate-y-1' 
                                      : 'border border-gray-200 hover:border-gray-300 hover:-translate-y-1'
                                    }
                                    before:absolute before:rounded-lg before:inset-0 before:bottom-[-5px] 
                                    before:bg-gray-100 before:-z-10 before:border before:border-gray-200
                                  `}
                                  onClick={() => field.onChange(category.value)}
                                >
                                  <div className="p-4">
                                    <RadioGroupItem
                                      value={category.value}
                                      id={category.value}
                                      className="sr-only"
                                    />
                                    <div className="flex items-center">
                                      <div className={`mr-3 text-2xl p-2 rounded-full ${field.value === category.value ? 'bg-primary/10' : 'bg-gray-100'}`}>
                                        {category.icon}
                                      </div>
                                      <div>
                                        <label 
                                          htmlFor={category.value}
                                          className="block font-medium cursor-pointer"
                                        >
                                          {category.label}
                                        </label>
                                        <span className="text-sm text-gray-500">{category.description}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </RadioGroup>
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                )}
                